<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capteurs test</title>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    pre { background: #f0f0f0; padding: 10px; border-radius: 5px; }
    button { padding: 10px 20px; font-size: 16px; margin-bottom: 10px; display: block; }
  </style>
</head>
<body>

  <h1>Test capteurs du smartphone</h1>

  <!-- Boutons -->
  <button onclick="startAll()">Démarrer Tout</button><br><br>

  <button onclick="startMicro()">Démarrer Micro</button>
  <pre id="microOutput">En attente...</pre>

  <button onclick="startCamera()">Démarrer Caméra</button>
  <video id="cameraVideo" width="320" height="240" autoplay></video>

  <button onclick="startGPS()">Démarrer GPS</button>
  <pre id="gpsOutput">En attente...</pre>

  <button onclick="startGyroscope()">Démarrer Gyroscope</button>
  <pre id="gyroOutput">En attente...</pre>

  <button onclick="startOrientation()">Démarrer Orientation</button>
  <pre id="orientationOutput">En attente...</pre>

  <button onclick="startBattery()">Démarrer Batterie</button>
  <pre id="batteryOutput">En attente...</pre>

  <button onclick="startTime()">Démarrer Heure</button>
  <pre id="timeOutput">En attente...</pre>

  <button onclick="startNetwork()">Démarrer Réseau</button>
  <pre id="networkOutput">En attente...</pre>

  <button onclick="startAccelerometer()">Démarrer Accéléromètre</button>
  <pre id="accelOutput">En attente...</pre>

  <button onclick="startLight()">Démarrer Capteur Lumière</button>
  <pre id="lightOutput">En attente...</pre>

  
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
/* -------------------------------------------------------------------------- */
/*                       🔌 Connexion Socket.IO au serveur                    */
/* -------------------------------------------------------------------------- */

// ⚠️ Mets ici l'IP du PC qui exécute Flask
const socket = io("http://192.168.50.238:5000");

// Fonction utilitaire pour envoyer les données au serveur
function sendSensor(type, data) {
  socket.emit("sensor", {
    type,          // Nom du capteur
    data,          // Données envoyées
    timestamp: Date.now()
  });
}


/* -------------------------------------------------------------------------- */
/*                                📍 GPS                                      */
/* -------------------------------------------------------------------------- */

function startGPS() {
  navigator.geolocation.watchPosition(position => {
    const data = {
      latitude: position.coords.latitude,
      longitude: position.coords.longitude,
      accuracy: position.coords.accuracy
    };

    document.getElementById('gpsOutput').textContent = JSON.stringify(data, null, 2);
    sendSensor("gps", data);
  });
}


/* -------------------------------------------------------------------------- */
/*                             📌 Accéléromètre                               */
/* -------------------------------------------------------------------------- */

function startAccelerometer() {
  window.addEventListener('devicemotion', e => {
    const data = {
      accelerationIncludingGravity: e.accelerationIncludingGravity,
      interval: e.interval
    };
    document.getElementById('accelOutput').textContent = JSON.stringify(data, null, 2);
    sendSensor("accelerometer", data);
  });
}


/* -------------------------------------------------------------------------- */
/*                               🎛 Gyroscope                                  */
/* -------------------------------------------------------------------------- */

function startGyroscope() {
  window.addEventListener('deviceorientation', event => {
    const data = {
      alpha: event.alpha,
      beta: event.beta,
      gamma: event.gamma
    };

    document.getElementById('gyroOutput').textContent = JSON.stringify(data, null, 2);
    sendSensor("gyroscope", data);
  });
}


/* -------------------------------------------------------------------------- */
/*                             🧭 Orientation                                  */
/* -------------------------------------------------------------------------- */

function startOrientation() {
  window.addEventListener('deviceorientation', event => {
    const data = {
      absolute: event.absolute,
      alpha: event.alpha,
      beta: event.beta,
      gamma: event.gamma
    };

    document.getElementById('orientationOutput').textContent = JSON.stringify(data, null, 2);
    sendSensor("orientation", data);
  });
}


/* -------------------------------------------------------------------------- */
/*                              🔋 Batterie                                    */
/* -------------------------------------------------------------------------- */

/*function startBattery() {
  if (!navigator.getBattery) return alert("API Batterie non supportée.");

  navigator.getBattery().then(battery => {
    function updateBattery() {
      const data = {
        level: battery.level,
        charging: battery.charging
      };

      document.getElementById('batteryOutput').textContent = JSON.stringify(data, null, 2);
      sendSensor("battery", data);
    }

    battery.addEventListener('levelchange', updateBattery);
    battery.addEventListener('chargingchange', updateBattery);
    updateBattery();
  });
}*/


/* -------------------------------------------------------------------------- */
/*                                🎤 Microphone                                */
/* -------------------------------------------------------------------------- */

function startMicro() {
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      const audioContext = new AudioContext();
      const source = audioContext.createMediaStreamSource(stream);
      const analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;

      source.connect(analyser);
      const dataArray = new Uint8Array(analyser.frequencyBinCount);

      function updateMicro() {
        analyser.getByteTimeDomainData(dataArray);

        let sum = 0;
        for (let v of dataArray) sum += Math.abs(v - 128);

        const volume = sum / dataArray.length;

        document.getElementById("microOutput").textContent =
          "Volume approximatif : " + volume.toFixed(2);

        sendSensor("microphone", { volume });

        requestAnimationFrame(updateMicro);
      }

      updateMicro();
    })
    .catch(err => {
      document.getElementById("microOutput").textContent = "Erreur micro : " + err;
    });
}


/* -------------------------------------------------------------------------- */
/*                                📷 Caméra                                    */
/* -------------------------------------------------------------------------- */

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      document.getElementById("cameraVideo").srcObject = stream;
      // ⚠️ on n’envoie pas la vidéo brute pour le moment
    })
    .catch(err => alert("Erreur caméra : " + err.message));
}


/* -------------------------------------------------------------------------- */
/*                        💡 Capteur Lumière ambiante                          */
/* -------------------------------------------------------------------------- */

function startLight() {
  if (!("AmbientLightSensor" in window))
    return alert("Capteur lumière non supporté.");

  try {
    const sensor = new AmbientLightSensor();
    sensor.addEventListener("reading", () => {
      const data = { lux: sensor.illuminance };

      document.getElementById("lightOutput").textContent =
        JSON.stringify(data, null, 2);

      sendSensor("light", data);
    });
    sensor.start();
  } catch (err) {
    document.getElementById("lightOutput").textContent = "Erreur : " + err;
  }
}


/* -------------------------------------------------------------------------- */
/*                                 🕒 Heure                                    */
/* -------------------------------------------------------------------------- */

function startTime() {
  function updateTime() {
    const data = {
      localeTime: new Date().toLocaleTimeString(),
      fullDate: new Date().toLocaleString()
    };

    document.getElementById('timeOutput').textContent = JSON.stringify(data, null, 2);
    sendSensor("time", data);
  }

  updateTime();
  setInterval(updateTime, 1000);
}


/* -------------------------------------------------------------------------- */
/*                                 🌐 Réseau                                   */
/* -------------------------------------------------------------------------- */

function startNetwork() {
  if (!navigator.connection)
    return alert("API réseau non supportée.");

  function updateNetwork() {
    const c = navigator.connection;

    const data = {
      effectiveType: c.effectiveType,
      downlink: c.downlink,
      rtt: c.rtt,
      saveData: c.saveData
    };

    document.getElementById('networkOutput').textContent = JSON.stringify(data, null, 2);
    sendSensor("network", data);
  }

  navigator.connection.addEventListener('change', updateNetwork);
  updateNetwork();
}


/* -------------------------------------------------------------------------- */
/*                         🚀 Bouton : Démarrer tout                           */
/* -------------------------------------------------------------------------- */

function startAll() {
  startGPS();
  startAccelerometer();
  startGyroscope();
  startOrientation();
  //startBattery();
  startMicro();
  startCamera();
  startLight();
  startTime();
  startNetwork();
}

</script>

</body>
</html>
