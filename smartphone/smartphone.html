<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Marco Dolci, Christophe Debons, Ayman Akram, Alexandre Mengotti">
    <title>SmartCoskpitSensor</title>
    <style>
        body {
            font-family: sans-serif;
            background: radial-gradient(circle at top left, rgba(95, 108, 124, 0.7), rgba(0, 0, 0, 0.8) 40%);
            color: white;
            margin: 0;
            padding: 0;
        }

        * {
            box-sizing: border-box;
        }

        h1 {
            margin: 22px 0 0 15px;
            font-size: 20px;
            text-align: center;
        }

        main {
            
            margin: 80px 10px 30px 10px;
            width: calc(100% - 20px);
            align-content: center;
            text-align: center ;
        }

        .entete {
            position: fixed;
            display: flex;
            top: 0;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            width: 100%;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .bannier {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            background-color:transparent;
            background-color: rgba(0, 0, 0, 0.2); /* noir semi-transparent pour assombrir */
            backdrop-filter: blur(30px);  /*flou */
        }

        pre {
            background: #f0f0f0;
            color: #333;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 50px);
            margin-bottom: 30px;
            text-align: left ;
            margin-left: auto;
            margin-right: auto;
        }

        video {
            display: block;
            width: calc(100% - 50px);
            margin-top: 10px; 
            margin-bottom: 30px;
            background: #f0f0f0;
            border-radius: 5px;
            z-index: -1;
            margin-left: auto;
            margin-right: auto;
        }

        .sensor {
            margin-bottom: 20px;
        }

        button {
            background-color: #4caf50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            text-decoration: none;
            width: calc(100% - 50px);
        }

        /* * {
        outline: 1px solid rgba(157, 255, 0, 0.2); 
        } */
    </style>
</head>

<header class="entete">
	<div class="bannier"> <h1>Smart Cockpit Sensor</h1></div>
</header>

<body>
    <main>
        <button onclick="startAll()">Démarrer tout</button>

        <pre id="logOutput">Logs WebSocket et capteurs :</pre>

        <button onclick="startGPS()">GPS</button>
        <pre id="gpsOutput">En attente...</pre>

        <button onclick="startAccelerometer()">Accéléromètre</button>
        <pre id="accelOutput">En attente...</pre>

        <button onclick="startOrientation()">Orientation</button>
        <pre id="orientationOutput">En attente...</pre>

        <button onclick="startBattery()">Batterie</button>
        <pre id="batteryOutput">En attente...</pre>

        <button onclick="startMicro()">Micro</button>
        <pre id="microOutput">En attente...</pre>

        <button onclick="startCamera()">Caméra</button>
        <video id="cameraVideo" width="180" height="auto" autoplay></video>

        <button onclick="startTime()">Heure</button>
        <pre id="timeOutput">En attente...</pre>

        <button onclick="startNetwork()">Réseau</button>
        <pre id="networkOutput">En attente...</pre>
    </main>

    <script>
        const ws = new WebSocket("wss://smartphone-datas.onrender.com");

        // Fonction pour afficher les logs dans la page
        function log(msg) {
            const pre = document.getElementById('logOutput');
            pre.textContent += msg + "\n";
        }

        // Fonction pour envoyer les données via WebSocket
        function sendSensor(name, data) {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ capteur: name, data }));
                log("Envoyé : " + name);
            } else {
                log("WebSocket pas encore ouverte, réessai pour " + name);
                setTimeout(() => sendSensor(name, data), 500);
            }
        }

        // WebSocket événements
        ws.onopen = () => {
            log("WebSocket ouverte !");
            // test simple : message toutes les secondes
            setInterval(() => sendSensor("test", { msg: "Hello cockpit !" }), 1000);
        };

        ws.onmessage = e => log("Reçu du serveur : " + e.data);
        ws.onerror = e => log("Erreur WebSocket : " + e);
        ws.onclose = e => log("WebSocket fermée.");

        // -------- Capteurs --------
        function startGPS() {
            navigator.geolocation.watchPosition(
                position => {
                    const data = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: position.timestamp
                    };
                    document.getElementById('gpsOutput').textContent = JSON.stringify(data, null, 2);
                    sendSensor("gps", data);
                },
                error => console.error("Erreur GPS :", error)
            );
        }

        function startAccelerometer() {
            window.addEventListener('devicemotion', event => {
                const data = {
                    accelerationIncludingGravity: event.accelerationIncludingGravity,
                    interval: event.interval
                };
                document.getElementById('accelOutput').textContent = JSON.stringify(data, null, 2);
                sendSensor("accelerometre", data);
            });
        }

        function startOrientation() {
            window.addEventListener('deviceorientation', event => {
                const data = {
                    absolute: event.absolute,
                    alpha: event.alpha,
                    beta: event.beta,
                    gamma: event.gamma
                };
                document.getElementById('orientationOutput').textContent = JSON.stringify(data, null, 2);
                sendSensor("orientation", data);
            });
        }

        function startBattery() {
            if (!navigator.getBattery) { alert("API batterie non supportée"); return; }
            navigator.getBattery().then(battery => {
                function updateBattery() {
                    const data = {
                        level: battery.level * 100 + '%',
                        charging: battery.charging,
                        chargingTime: battery.chargingTime,
                        dischargingTime: battery.dischargingTime
                    };
                    document.getElementById('batteryOutput').textContent = JSON.stringify(data, null, 2);
                    sendSensor("battery", data);
                }
                battery.addEventListener('levelchange', updateBattery);
                battery.addEventListener('chargingchange', updateBattery);
                updateBattery();
            });
        }

        function startMicro() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("Microphone non supporté"); return; }
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(stream);
                    const analyser = audioContext.createAnalyser();
                    source.connect(analyser);
                    analyser.fftSize = 256;
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);

                    function updateMicro() {
                        analyser.getByteTimeDomainData(dataArray);
                        let sum = 0;
                        for (let i = 0; i < dataArray.length; i++) sum += Math.abs(dataArray[i] - 128);
                        const volume = sum / dataArray.length;
                        const data = { volume };
                        document.getElementById('microOutput').textContent = "Volume : " + volume.toFixed(2);
                        sendSensor("micro", data);
                        requestAnimationFrame(updateMicro);
                    }
                    updateMicro();
                })
                .catch(err => document.getElementById('microOutput').textContent = "Erreur micro : " + err.message);
        }

        function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("Caméra non supportée"); return; }
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    const video = document.getElementById('cameraVideo');
                    video.srcObject = stream;
                    sendSensor("camera", { status: "streaming" });
                })
                .catch(err => console.error("Erreur caméra :", err));
        }

        function startLight() {
            if (!('AmbientLightSensor' in window)) { alert("Capteur lumière non supporté"); return; }
            try {
                const sensor = new AmbientLightSensor({ frequency: 1 });
                sensor.addEventListener('reading', () => {
                    const data = { illuminance: sensor.illuminance };
                    document.getElementById('lightOutput').textContent = JSON.stringify(data, null, 2);
                    sendSensor("light", data);
                });
                sensor.addEventListener('error', event => document.getElementById('lightOutput').textContent = 'Erreur lumière: ' + event.error.name);
                sensor.start();
            } catch (e) {
                document.getElementById('lightOutput').textContent = 'Erreur lumière: ' + e.message;
            }
        }

        function startTime() {
            function updateTime() {
                const now = new Date();
                const data = { localeTime: now.toLocaleTimeString(), fullDate: now.toLocaleString() };
                document.getElementById('timeOutput').textContent = JSON.stringify(data, null, 2);
                sendSensor("time", data);
            }
            updateTime();
            setInterval(updateTime, 1000);
        }

        function startNetwork() {
            if (!navigator.connection) { alert("API réseau non supportée"); return; }
            function updateNetwork() {
                const conn = navigator.connection;
                const data = {
                    effectiveType: conn.effectiveType,
                    downlink: conn.downlink + " Mbps",
                    rtt: conn.rtt + " ms",
                    saveData: conn.saveData
                };
                document.getElementById('networkOutput').textContent = JSON.stringify(data, null, 2);
                sendSensor("network", data);
            }
            navigator.connection.addEventListener('change', updateNetwork);
            updateNetwork();
        }

        // Démarrer tous les capteurs
        function startAll() {
            startGPS();
            startAccelerometer();
            startOrientation();
            startBattery();
            startMicro();
            startCamera();
            startTime();
            startNetwork();
        }

    </script>
</body>

</html>