<!DOCTYPE html>
<html lang="fr">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="author" content="Marco Dolci, Christophe Debons, Ayman Akram, Alexandre Mengotti">
	<title>SmartCockpit</title>
	<link rel="stylesheet" href="Style.css">
</head>

<header class="entete">
	<div class="bannier"> <h1>SmartCockpit</h1></div>
</header>

<body>
	<main>
		<div class = "grid-container-widgets">
			<div class="widget" id="orientationWidget3D">
				<h2>Orientation 3D</h2>
			</div>
			<div class="widget" id="orientationWidget">
				<h2>Orientation 2D</h2>
				<div class="car-container">
					<img id="carTop" src="Images/car_top.png" alt="Car top">
					<img id="carSide" src="Images/car_side.png" alt="Car side">
					<img id="carBack" src="Images/car_back.png" alt="Car back">
				</div>
			</div>
			<div class="widget" id="localisationWidget">
				<h2>Localisation</h2>
			</div>
			<div class="widget" id="boussoleWidget">
				<h2>Boussole</h2>
			</div>
			<div class="widget" id="meteoWidget">
				<h2>Météo</h2>
			</div>
            <div class="widget" id="cameraWidget">
				<h2>Caméra</h2>
			</div>
			<div class="widget" id="microWidget">
				<h2>Micro</h2>
			</div>
            <div class="widget" id="batterieWidget">
				<h2>Batterie</h2>
			</div>
            <div class="widget" id="heureWidget">
				<h2>Heure</h2>
			</div>
            <div class="widget" id="reseauWidget">
				<h2>Réseau</h2>
			</div>
		</div>

		<div class = "debug-container">
			<h2 class="title-debug" onclick="toggleDebug()">
				<span class="title-text">Debugeur</span>
				<span class="title-arrow">▼</span>
			</h2>
			<div id="debugContent">
				<div class="sensor">
					<h2>Logs WebSocket</h2>
					<pre id="logOutput">En attente de connexion...</pre>
				</div>

				<div class="sensor">
					<h2>GPS</h2>
					<pre id="gpsOutput">En attente...</pre>
				</div>

				<div class="sensor">
					<h2>Accéléromètre</h2>
					<pre id="accelOutput">En attente...</pre>
				</div>

				<div class="sensor">
					<h2>Gyroscope</h2>
					<pre id="gyroOutput">En attente...</pre>
				</div>

				<div class="sensor">
					<h2>Orientation</h2>
					<pre id="orientationOutput">En attente...</pre>
				</div>

				<div class="sensor">
					<h2>Batterie</h2>
					<pre id="batteryOutput">En attente...</pre>
				</div>

				<div class="sensor">
					<h2>Microphone</h2>
					<pre id="microOutput">En attente...</pre>
				</div>

				<div class="sensor">
					<h2>Caméra</h2>
					<video id="cockpitVideo" width="640" height="480" autoplay></video>
				</div>

				<div class="sensor">
					<h2>Lumière</h2>
					<pre id="lightOutput">En attente...</pre>
				</div>

				<div class="sensor">
					<h2>Heure</h2>
					<pre id="timeOutput">En attente...</pre>
				</div>

				<div class="sensor">
					<h2>Réseau</h2>
					<pre id="networkOutput">En attente...</pre>
				</div>
			</div>
		</div>
	</main>

	<script>
		const ws = new WebSocket("wss://smartphone-datas.onrender.com");

		let lastAlpha = 0;
		let lastBeta = 0;
		let lastGamma = 0;
		
		// Affiche les logs dans la page
		function log(msg) {
			const pre = document.getElementById('logOutput');
			pre.textContent += msg + "\n";
			pre.scrollTop = pre.scrollHeight;
		}

		function smoothAlpha(alpha) {
			let diff = alpha - lastAlpha;

			// corrige les sauts > 180°
			if (diff > 180) diff -= 360;
			if (diff < -180) diff += 360;

			// applique un lissage
			lastAlpha += diff * 0.1; // 0.1 = vitesse de lissage (0 = pas de mouvement, 1 = sans lissage)
			return lastAlpha;
		}

		function smoothBeta(beta) {
			let diff = beta - lastBeta;

			// corrige les sauts > 180°
			if (diff > 180) diff -= 360;
			if (diff < -180) diff += 360;

			// applique un lissage
			lastBeta += diff * 0.1; // 0.1 = vitesse de lissage (0 = pas de mouvement, 1 = sans lissage)
			return lastBeta;
		}

		function smoothGamma(gamma) {
			let diff = gamma - lastGamma;

			// corrige les sauts > 180°
			if (diff > 180) diff -= 360;
			if (diff < -180) diff += 360;

			// applique un lissage
			lastGamma += diff * 0.1; // 0.1 = vitesse de lissage (0 = pas de mouvement, 1 = sans lissage)
			return lastGamma;
		}

		// Gestion WebSocket
		ws.onopen = () => log("WebSocket ouverte !");
		ws.onmessage = event => {
			const msg = JSON.parse(event.data);
			log("Reçu : " + JSON.stringify(msg));
			const data = msg.data;

			switch (msg.capteur) {
				case "gps": document.getElementById('gpsOutput').textContent = JSON.stringify(data, null, 2); break;
				case "accelerometre": document.getElementById('accelOutput').textContent = JSON.stringify(data, null, 2); break;
				case "gyroscope": document.getElementById('gyroOutput').textContent = JSON.stringify(data, null, 2); break;
				case "orientation":
					document.getElementById('orientationOutput').textContent = JSON.stringify(data, null, 2);

					const carTop = document.getElementById("carTop");
					const carSide = document.getElementById("carSide");
					const carBack = document.getElementById("carBack");

					const alpha = data.alpha || 0;		// rotation Z
					const beta  = data.beta  || 0;   	// rotation X
    				const gamma = data.gamma || 0;   	// rotation Y

					const smoothAlphaValue = smoothAlpha(alpha);
					const smoothGammaValue = smoothGamma(gamma);
					const smoothBetaValue  = smoothBeta(beta);

					carTop.style.transform = `rotateZ(${-smoothAlphaValue}deg)`;
					carSide.style.transform = `rotateZ(${-smoothBetaValue}deg)`;
					carBack.style.transform = `rotateZ(${smoothGammaValue}deg)`; 

					break;

				case "battery": document.getElementById('batteryOutput').textContent = JSON.stringify(data, null, 2); break;
				case "micro": document.getElementById('microOutput').textContent = JSON.stringify(data, null, 2); break;
				case "camera": document.getElementById('cameraVideo').title = "Streaming"; break;
				case "light": document.getElementById('lightOutput').textContent = JSON.stringify(data, null, 2); break;
				case "time": document.getElementById('timeOutput').textContent = JSON.stringify(data, null, 2); break;
				case "network": document.getElementById('networkOutput').textContent = JSON.stringify(data, null, 2); break;
				default: break;
			}
		};

		ws.onerror = e => log("Erreur WebSocket : " + e);
		ws.onclose = e => log("WebSocket fermée.");

		// Fonction pour envoyer les données depuis le smartphone
		function sendSensor(name, data) {
			if (ws.readyState === WebSocket.OPEN) {
				ws.send(JSON.stringify({ capteur: name, data }));
				log("Envoyé : " + name);
			} else {
				log("WebSocket pas ouverte pour " + name + ", réessai...");
				setTimeout(() => sendSensor(name, data), 500);
			}
		}

		// Toggle debug section
		function toggleDebug() {
			const content = document.getElementById('debugContent');
			content.classList.toggle('hidden');

			const arrow = document.querySelector('.title-arrow');
			if (content.classList.contains('hidden')) {
				arrow.textContent = "►"; // fermé
			} else {
				arrow.textContent = "▼"; // ouvert
			}
		}
	</script>
</body>

</html>