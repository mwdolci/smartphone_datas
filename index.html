<script>
const ws = new WebSocket("ws://192.168.1.108:8080");

function sendSensor(name, data) {
    if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ capteur: name, data }));
    }
}

// ---------------- GPS ----------------
function startGPS() {
    navigator.geolocation.watchPosition(
        position => {
            const data = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: position.timestamp
            };
            document.getElementById('gpsOutput').textContent = JSON.stringify(data, null, 2);
            sendSensor("gps", data);
        },
        error => console.error("Erreur GPS :", error)
    );
}

// ---------------- Accéléromètre ----------------
function startAccelerometer() {
    window.addEventListener('devicemotion', event => {
        const data = {
            accelerationIncludingGravity: event.accelerationIncludingGravity,
            interval: event.interval
        };
        document.getElementById('accelOutput').textContent = JSON.stringify(data, null, 2);
        sendSensor("accelerometre", data);
    });
}

// ---------------- Gyroscope ----------------
function startGyroscope() {
    window.addEventListener('deviceorientation', event => {
        const data = {
            alpha: event.alpha,
            beta: event.beta,
            gamma: event.gamma
        };
        document.getElementById('gyroOutput').textContent = JSON.stringify(data, null, 2);
        sendSensor("gyroscope", data);
    });
}

// ---------------- Orientation ----------------
function startOrientation() {
    window.addEventListener('deviceorientation', event => {
        const data = {
            absolute: event.absolute,
            alpha: event.alpha,
            beta: event.beta,
            gamma: event.gamma
        };
        document.getElementById('orientationOutput').textContent = JSON.stringify(data, null, 2);
        sendSensor("orientation", data);
    });
}

// ---------------- Batterie ----------------
function startBattery() {
    if (!navigator.getBattery) {
        alert("API batterie non supportée sur ce navigateur.");
        return;
    }

    navigator.getBattery().then(battery => {
        function updateBattery() {
            const data = {
                level: battery.level * 100 + '%',
                charging: battery.charging,
                chargingTime: battery.chargingTime,
                dischargingTime: battery.dischargingTime
            };
            document.getElementById('batteryOutput').textContent = JSON.stringify(data, null, 2);
            sendSensor("battery", data);
        }

        battery.addEventListener('levelchange', updateBattery);
        battery.addEventListener('chargingchange', updateBattery);

        updateBattery(); // affichage initial
    });
}

// ---------------- Micro ----------------
function startMicro() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Microphone non supporté.");
        return;
    }

    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(stream);
            const analyser = audioContext.createAnalyser();
            source.connect(analyser);
            analyser.fftSize = 256;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function updateMicro() {
                analyser.getByteTimeDomainData(dataArray);
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) sum += Math.abs(dataArray[i] - 128);
                const volume = sum / dataArray.length;
                const data = { volume };
                document.getElementById('microOutput').textContent = "Volume approximatif : " + volume.toFixed(2);
                sendSensor("micro", data);
                requestAnimationFrame(updateMicro);
            }

            updateMicro();
        })
        .catch(err => {
            document.getElementById('microOutput').textContent = "Erreur micro : " + err.message;
        });
}

// ---------------- Caméra ----------------
function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Caméra non supportée.");
        return;
    }

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;
            sendSensor("camera", { status: "streaming" });
        })
        .catch(err => {
            console.error("Erreur caméra :", err);
            alert("Impossible d'accéder à la caméra : " + err.message);
        });
}

// ---------------- Capteur lumière ----------------
function startLight() {
    if (!('AmbientLightSensor' in window)) {
        alert("Capteur de lumière ambiante non supporté.");
        return;
    }

    try {
        const sensor = new AmbientLightSensor({ frequency: 1 });
        sensor.addEventListener('reading', () => {
            const data = { illuminance: sensor.illuminance };
            document.getElementById('lightOutput').textContent = JSON.stringify(data, null, 2);
            sendSensor("light", data);
        });
        sensor.addEventListener('error', event => {
            document.getElementById('lightOutput').textContent = 'Erreur capteur lumière: ' + event.error.name;
        });
        sensor.start();
    } catch (err) {
        document.getElementById('lightOutput').textContent = 'Erreur capteur lumière: ' + err.message;
    }
}

// ---------------- Heure ----------------
function startTime() {
    function updateTime() {
        const now = new Date();
        const data = {
            localeTime: now.toLocaleTimeString(),
            fullDate: now.toLocaleString()
        };
        document.getElementById('timeOutput').textContent = JSON.stringify(data, null, 2);
        sendSensor("time", data);
    }

    updateTime();
    setInterval(updateTime, 1000);
}

// ---------------- Réseau ----------------
function startNetwork() {
    if (!navigator.connection) {
        alert("API réseau non supportée sur ce navigateur.");
        return;
    }

    function updateNetwork() {
        const connection = navigator.connection;
        const data = {
            effectiveType: connection.effectiveType,
            downlink: connection.downlink + " Mbps",
            rtt: connection.rtt + " ms",
            saveData: connection.saveData
        };
        document.getElementById('networkOutput').textContent = JSON.stringify(data, null, 2);
        sendSensor("network", data);
    }

    navigator.connection.addEventListener('change', updateNetwork);
    updateNetwork();
}

// ---------------- Démarrer tout ----------------
function startAll() {
    startGPS();
    startAccelerometer();
    startGyroscope();
    startOrientation();
    startBattery();
    startMicro();
    startCamera();
    startLight();
    startTime();
    startNetwork();
}
</script>
