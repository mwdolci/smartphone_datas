<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capteurs test</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    pre { background: #f0f0f0; padding: 10px; border-radius: 5px; }
    button { padding: 10px 20px; font-size: 16px; margin-bottom: 10px; display: block; }
  </style>
</head>
<body>
  <h1>Test capteurs du smartphone</h1>
  <button onclick="startAll()">Démarrer Tout</button><br><br>
  <button onclick="startMicro()">Démarrer Micro</button>
  <pre id="microOutput">En attente...</pre>
  <button onclick="startCamera()">Démarrer Caméra</button>
  <video id="cameraVideo" width="320" height="240" autoplay></video>
  <button onclick="startGPS()">Démarrer GPS</button>
  <pre id="gpsOutput">En attente...</pre>
  <button onclick="startGyroscope()">Démarrer Gyroscope</button>
  <pre id="gyroOutput">En attente...</pre>
  <button onclick="startOrientation()">Démarrer Orientation</button>
  <pre id="orientationOutput">En attente...</pre>
  <button onclick="startBattery()">Démarrer Batterie</button>
  <pre id="batteryOutput">En attente...</pre>
  <button onclick="startLight()">Démarrer Capteur Lumière</button>
  <pre id="lightOutput">En attente...</pre>
  <button onclick="startTime()">Démarrer Heure</button>
  <pre id="timeOutput">En attente...</pre>
  <button onclick="startAccelerometer()">Démarrer Accéléromètre</button>
  <pre id="accelOutput">En attente...</pre>

  <script>	
	let watchID;

	function startGPS() {
	  navigator.geolocation.watchPosition(
		position => {
		  const data = {
			latitude: position.coords.latitude,
			longitude: position.coords.longitude,
			accuracy: position.coords.accuracy,
			timestamp: position.timestamp
		  };
		  document.getElementById('gpsOutput').textContent = JSON.stringify(data, null, 2);
		}
	  );
	}

	function startAccelerometer() {
	  window.addEventListener('devicemotion', event => {
		const data = {
		  accelerationIncludingGravity: event.accelerationIncludingGravity,
		  interval: event.interval
		};
		document.getElementById('accelOutput').textContent = JSON.stringify(data, null, 2);
	  });
	}

	function startGyroscope() {
	  window.addEventListener('deviceorientation', event => {
		const data = {
		  alpha: event.alpha,
		  beta: event.beta,
		  gamma: event.gamma
		};
		document.getElementById('gyroOutput').textContent = JSON.stringify(data, null, 2);
	  });
	}

	function startOrientation() {
	  window.addEventListener('deviceorientation', event => {
		const data = {
		  absolute: event.absolute,
		  alpha: event.alpha,
		  beta: event.beta,
		  gamma: event.gamma
		};
		document.getElementById('orientationOutput').textContent = JSON.stringify(data, null, 2);
	  });
	}
	
	function startBattery() {
	  if (!navigator.getBattery) {
		alert("API batterie non supportée sur ce navigateur.");
		return;
	  }

	  navigator.getBattery().then(battery => {
		function updateBattery() {
		  const data = {
			level: battery.level * 100 + '%',
			charging: battery.charging,
			chargingTime: battery.chargingTime,
			dischargingTime: battery.dischargingTime
		  };
		  document.getElementById('batteryOutput').textContent = JSON.stringify(data, null, 2);
		}

		// Événements pour mise à jour automatique
		battery.addEventListener('levelchange', updateBattery);
		battery.addEventListener('chargingchange', updateBattery);

		// Premier affichage
		updateBattery();
	  });
	}
	
	function startMicro() {
	  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
		alert("Microphone non supporté.");
		return;
	  }

	  navigator.mediaDevices.getUserMedia({ audio: true })
		.then(stream => {
		  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
		  const source = audioContext.createMediaStreamSource(stream);
		  const analyser = audioContext.createAnalyser();
		  source.connect(analyser);
		  analyser.fftSize = 256;
		  const dataArray = new Uint8Array(analyser.frequencyBinCount);

		  function updateMicro() {
			analyser.getByteTimeDomainData(dataArray);
			let sum = 0;
			for (let i = 0; i < dataArray.length; i++) {
			  sum += Math.abs(dataArray[i] - 128);
			}
			const volume = sum / dataArray.length;
			document.getElementById('microOutput').textContent = "Volume approximatif : " + volume.toFixed(2);
			requestAnimationFrame(updateMicro);
		  }

		  updateMicro();
		})
		.catch(err => {
		  document.getElementById('microOutput').textContent = "Erreur micro : " + err.message;
		});
	}
	
	function startCamera() {
	  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
		alert("Caméra non supportée.");
		return;
	  }

	  navigator.mediaDevices.getUserMedia({ video: true })
		.then(stream => {
		  const video = document.getElementById('cameraVideo');
		  video.srcObject = stream;
		})
		.catch(err => {
		  console.error("Erreur caméra :", err);
		  alert("Impossible d'accéder à la caméra : " + err.message);
		});
	}
	
	function startLight() {
	  if (!('AmbientLightSensor' in window)) {
		alert("Capteur de lumière ambiante non supporté sur ce navigateur.");
		return;
	  }

	  try {
		const sensor = new AmbientLightSensor({ frequency: 1 }); // fréquence 1Hz
		sensor.addEventListener('reading', () => {
		  const data = {
			illuminance: sensor.illuminance // en lux
		  };
		  document.getElementById('lightOutput').textContent = JSON.stringify(data, null, 2);
		});
		sensor.addEventListener('error', event => {
		  document.getElementById('lightOutput').textContent = 'Erreur capteur lumière: ' + event.error.name;
		});
		sensor.start();
	  } catch (err) {
		document.getElementById('lightOutput').textContent = 'Erreur capteur lumière: ' + err.message;
	  }
	}
	
	function startTime() {
	  function updateTime() {
		const now = new Date();
		const data = {
		  localeTime: now.toLocaleTimeString(),
		  fullDate: now.toLocaleString()
		};
		document.getElementById('timeOutput').textContent = JSON.stringify(data, null, 2);
	  }

	  // Mettre à jour toutes les secondes
	  updateTime();
	  setInterval(updateTime, 1000);
	}
	
	function startAll() {
	  startGPS();
	  startAccelerometer();
	  startGyroscope();
	  startOrientation();
	  startBattery();
	  startMicro();
	  startCamera();
	  startLight();
	  startTime();
	}

  </script>
</body>
</html>
